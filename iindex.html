<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worldcoin Betting Platform</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <script src="https://unpkg.com/@worldcoin/mini-kit-js/dist/index.umd.js"></script>
    <style>
        :root {
            --primary: #2B6CB0;
            --success: #38A169;
            --error: #E53E3E;
            --background: #F7FAFC;
        }

        body {
            font-family: 'Segoe UI', system-ui;
            background: var(--background);
            margin: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 2rem;
        }

        .bet-card {
            border: 1px solid #E2E8F0;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin: 1rem 0;
            transition: transform 0.2s;
        }

        .bet-card:hover {
            transform: translateY(-2px);
        }

        .odds-badge {
            background: var(--primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 999px;
            cursor: pointer;
        }

        .wallet-section {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 2rem;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { WorldIDComponent, SignIn } = window.WorldCoinMiniKit;

        class BettingPlatform extends React.Component {
            state = {
                isVerified: false,
                walletAddress: '',
                balance: 0,
                events: [],
                selectedBet: null
            }

            componentDidMount() {
                this.loadSportsEvents();
                this.checkWalletConnection();
            }

            loadSportsEvents = async () => {
                // Simular datos en tiempo real
                setInterval(() => {
                    this.setState({
                        events: [
                            {
                                id: 1,
                                teams: 'Real Madrid vs Barcelona',
                                odds: { home: 1.85, draw: 3.40, away: 4.20 },
                                score: '2-1',
                                time: '63\''
                            },
                            {
                                id: 2,
                                teams: 'Manchester City vs Liverpool',
                                odds: { home: 2.10, draw: 3.25, away: 3.80 },
                                score: '0-0',
                                time: '15\''
                            }
                        ]
                    });
                }, 5000);
            }

            checkWalletConnection = async () => {
                if (window.ethereum) {
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    const accounts = await provider.listAccounts();
                    if (accounts.length > 0) {
                        this.setState({
                            walletAddress: accounts[0],
                            balance: await this.getUSDCBalance(accounts[0])
                        });
                    }
                }
            }

            getUSDCBalance = async (address) => {
                // Simular balance
                return 1500; // USDC
            }

            handleVerificationSuccess = (proof) => {
                // Verificar prueba en backend
                fetch('/api/verify-worldid', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ proof })
                }).then(res => {
                    if (res.ok) this.setState({ isVerified: true });
                });
            }

            placeBet = async (eventId, outcome, amount) => {
                if (!this.state.isVerified) return alert('Verifica con Worldcoin primero');
                
                const tx = await this.sendUSDCTransaction(
                    '0xBookmakerAddress', 
                    amount
                );

                if (tx) {
                    // Registrar apuesta en contrato inteligente
                    const betResult = await fetch('/api/place-bet', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            eventId,
                            outcome,
                            amount,
                            txHash: tx.hash
                        })
                    });

                    if (betResult.ok) alert('Apuesta colocada!');
                }
            }

            sendUSDCTransaction = async (to, amount) => {
                try {
                    const provider = new ethers.providers.Web3Provider(window.ethereum);
                    const signer = provider.getSigner();
                    
                    const usdcContract = new ethers.Contract(
                        '0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48',
                        ['function transfer(address, uint256)'],
                        signer
                    );

                    return await usdcContract.transfer(
                        to,
                        ethers.utils.parseUnits(amount.toString(), 6)
                    );
                } catch (error) {
                    console.error('Transaction error:', error);
                }
            }

            connectWallet = async () => {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                this.checkWalletConnection();
            }

            render() {
                return (
                    <div className="container">
                        <div className="wallet-section">
                            <WorldIDComponent
                                actionId="wid_prod_123456"
                                signal={this.state.walletAddress}
                                onSuccess={this.handleVerificationSuccess}
                            >
                                {(props) => (
                                    <SignIn.Button 
                                        {...props}
                                        style={{ 
                                            backgroundColor: this.state.isVerified ? var(--success) : var(--primary),
                                            padding: '0.75rem 1.5rem'
                                        }}
                                    />
                                )}
                            </WorldIDComponent>

                            {this.state.walletAddress ? (
                                <div>
                                    <p>{this.state.walletAddress.slice(0,6)}...{this.state.walletAddress.slice(-4)}</p>
                                    <p>Balance: {this.state.balance} USDC</p>
                                </div>
                            ) : (
                                <button onClick={this.connectWallet}>Conectar Wallet</button>
                            )}
                        </div>

                        {this.state.isVerified && (
                            <div>
                                <h2>âš½ Eventos en Vivo</h2>
                                {this.state.events.map(event => (
                                    <div key={event.id} className="bet-card">
                                        <h3>{event.teams}</h3>
                                        <p>Marcador: {event.score} ({event.time})</p>
                                        <div style={{ display: 'flex', gap: '1rem', marginTop: '1rem' }}>
                                            <div className="odds-badge" onClick={() => this.placeBet(event.id, 'home', 100)}>
                                                Local {event.odds.home}
                                            </div>
                                            <div className="odds-badge" onClick={() => this.placeBet(event.id, 'draw', 100)}>
                                                Empate {event.odds.draw}
                                            </div>
                                            <div className="odds-badge" onClick={() => this.placeBet(event.id, 'away', 100)}>
                                                Visitante {event.odds.away}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            }
        }

        ReactDOM.render(<BettingPlatform />, document.getElementById('root'));
    </script>
</body>
</html>
