<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Worldcoin Full Integration</title>
    <style>
        :root {
            --primary: #4F46E5;
            --success: #10B981;
            --error: #EF4444;
            --background: #f3f4f6;
            --text: #111827;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            margin: 0;
            padding: 2rem;
            color: var(--text);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        .section {
            margin: 2rem 0;
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        button:hover {
            opacity: 0.9;
        }

        input {
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            width: 100%;
            margin: 0.5rem 0;
        }

        .status {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
        }

        .success { background: #D1FAE5; color: var(--success); }
        .error { background: #FEE2E2; color: var(--error); }
        .loading { background: #EFF6FF; color: var(--primary); }

        .spinner {
            animation: spin 1s linear infinite;
            border: 3px solid #e5e7eb;
            border-top-color: var(--primary);
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            display: inline-block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Worldcoin Integration Demo</h1>
        
        <!-- Sección de Login -->
        <div class="section">
            <h2>🔑 Autenticación</h2>
            <button onclick="handleLogin()" id="loginBtn">Iniciar Sesión con Worldcoin</button>
            <div id="loginStatus"></div>
        </div>

        <!-- Sección de Verificación -->
        <div class="section">
            <h2>🆔 Verificación World ID</h2>
            <button onclick="handleVerification()">Verificar Identidad</button>
            <div id="verificationStatus"></div>
        </div>

        <!-- Sección de Pagos -->
        <div class="section">
            <h2>💸 Sistema de Pagos</h2>
            <input type="number" id="amount" value="0.5" step="0.1" placeholder="Monto en WLD">
            <button onclick="handlePayment()">Realizar Pago</button>
            <div id="paymentStatus"></div>
        </div>
    </div>

    <script>
        // Configuración con variables proporcionadas
        const CONFIG = {
            APP_ID: "app_2248679d8f07eb1b7eacd922f9a26a1e",
            API_KEY: "api_a2V5XzM1M2U4ZDA4NjBkZjU5Y2MxZDE3NGNmODZjZjc4MTcwOnNrX2YwMzVmYzA3ZTFiNGY0MTQ5NWQxZmNkMjNkMDY2NGYxMTk3MGVkMTA2ZWFkMDhiMw",
            RECIPIENT: "0xde6b6e1cddbfd1d94afc01957748c36c36f43af4",
            JWT_SECRET: "sk_f41d2e783bf3990613e53d8e76c8ce9fc4ccb25f93859e14"
        };

        // Simulación de MiniKit
        const MiniKit = {
            commandsAsync: {
                walletAuth: async () => ({
                    finalPayload: {
                        status: 'success',
                        app_id: CONFIG.APP_ID,
                        jwt: CONFIG.JWT_SECRET
                    }
                }),
                verify: async (payload) => ({
                    finalPayload: {
                        status: 'success',
                        action_id: payload.action,
                        app_id: CONFIG.APP_ID
                    }
                }),
                pay: async (paymentData) => ({
                    finalPayload: {
                        status: 'success',
                        transaction_id: crypto.randomUUID(),
                        recipient: CONFIG.RECIPIENT,
                        amount: paymentData.tokens[0].token_amount
                    }
                })
            },
            isInstalled: () => true
        };

        // Manejo de Login
        async function handleLogin() {
            try {
                showLoading('login');
                
                // Generar nonce
                const nonce = await generateNonce();
                
                // Simular autenticación
                const { finalPayload } = await MiniKit.commandsAsync.walletAuth();
                
                if (finalPayload.jwt === CONFIG.JWT_SECRET) {
                    await verifyAuth(finalPayload);
                    showSuccess('login', 'Autenticación exitosa!');
                } else {
                    showError('login', 'Error en autenticación');
                }
            } catch (error) {
                showError('login', error.message);
            }
        }

        // Manejo de Verificación
        async function handleVerification() {
            try {
                showLoading('verification');
                
                const action = "test-action-2";
                const { finalPayload } = await MiniKit.commandsAsync.verify({ 
                    action,
                    verification_level: 'orb',
                    app_id: CONFIG.APP_ID
                });

                const verification = await verifyCloudProof(finalPayload, action);
                
                if (verification.success) {
                    showSuccess('verification', 'Verificación exitosa!');
                } else {
                    showError('verification', 'Error en verificación');
                }
            } catch (error) {
                showError('verification', error.message);
            }
        }

        // Manejo de Pagos
        async function handlePayment() {
            try {
                showLoading('payment');
                const amount = document.getElementById('amount').value;
                
                // Generar referencia
                const reference = await generatePaymentReference();
                
                // Simular pago
                const { finalPayload } = await MiniKit.commandsAsync.pay({
                    reference,
                    to: CONFIG.RECIPIENT,
                    tokens: [{
                        symbol: 'WLD',
                        token_amount: amount * 10**18
                    }]
                });

                // Confirmar pago
                const confirmation = await confirmPayment(reference);
                
                if (confirmation.success) {
                    showSuccess('payment', `Pago de ${amount} WLD exitoso!`);
                } else {
                    showError('payment', 'Error en transacción');
                }
            } catch (error) {
                showError('payment', error.message);
            }
        }

        // Funciones auxiliares
        async function generateNonce() {
            return crypto.randomUUID();
        }

        async function verifyAuth(payload) {
            // Simular verificación en backend
            return new Promise((resolve) => {
                setTimeout(() => resolve(payload.jwt === CONFIG.JWT_SECRET), 1000);
            });
        }

        async function verifyCloudProof(payload, action) {
            // Simular llamada a API de Worldcoin
            return {
                success: payload.app_id === CONFIG.APP_ID,
                action_id: action
            };
        }

        async function generatePaymentReference() {
            return crypto.randomUUID().replace(/-/g, '');
        }

        async function confirmPayment(reference) {
            // Simular confirmación de transacción
            return {
                success: true,
                transaction_id: reference,
                recipient: CONFIG.RECIPIENT
            };
        }

        // Manejo de UI
        function showLoading(section) {
            const element = document.getElementById(`${section}Status`);
            element.className = 'status loading';
            element.innerHTML = `<div class="spinner"></div> Procesando...`;
        }

        function showSuccess(section, message) {
            const element = document.getElementById(`${section}Status`);
            element.className = 'status success';
            element.textContent = message;
        }

        function showError(section, message) {
            const element = document.getElementById(`${section}Status`);
            element.className = 'status error';
            element.textContent = message;
        }
    </script>
</body>
</html>
